name: Integration Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  integration-test:
    name: Kafka Cluster Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r python/requirements.txt

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Start Kafka cluster
        run: |
          echo "Starting 5-broker Kafka cluster..."
          docker compose up -d

      - name: Wait for cluster health
        run: |
          echo "Waiting for brokers to become healthy..."
          BROKERS="kafka-1 kafka-2 kafka-3 kafka-4 kafka-5"
          MAX_RETRIES=30
          RETRY_INTERVAL=10

          for broker in $BROKERS; do
            retries=0
            while [ $retries -lt $MAX_RETRIES ]; do
              status=$(docker inspect --format='{{.State.Health.Status}}' "$broker" 2>/dev/null || echo "not_found")

              if [ "$status" = "healthy" ]; then
                echo "$broker: healthy"
                break
              fi

              echo "$broker: $status (attempt $((retries + 1))/$MAX_RETRIES)"
              retries=$((retries + 1))
              sleep $RETRY_INTERVAL
            done

            if [ $retries -eq $MAX_RETRIES ]; then
              echo "ERROR: $broker failed to become healthy"
              docker logs "$broker" --tail 50
              exit 1
            fi
          done

      - name: Verify broker topology
        run: |
          echo "Verifying broker configuration..."
          docker exec kafka-1 kafka-broker-api-versions --bootstrap-server kafka-1:29092 | head -5

      - name: Create poc_* topics
        run: |
          echo "Creating topics with manual replica assignment..."
          REPLICA_ASSIGNMENT="1:2:3,2:3:1,3:1:2,1:2:3,2:3:1,3:1:2"

          for topic in poc_orders poc_payments poc_inventory; do
            echo "Creating topic: $topic"
            docker exec kafka-1 kafka-topics \
              --bootstrap-server kafka-1:29092 \
              --create \
              --topic "$topic" \
              --replica-assignment "$REPLICA_ASSIGNMENT"
          done

      - name: Validate topic placement (shell)
        run: |
          echo "Running shell-based validation..."
          ./scripts/validate-placement.sh

      - name: Validate topic placement (Python)
        run: |
          echo "Running Python validation..."
          python python/topic_validator.py --bootstrap-servers localhost:9092

      - name: Inspect cluster state
        run: |
          echo "=== Topic Details ==="
          for topic in poc_orders poc_payments poc_inventory; do
            echo "--- $topic ---"
            docker exec kafka-1 kafka-topics \
              --bootstrap-server kafka-1:29092 \
              --describe \
              --topic "$topic"
          done

      - name: Test broker failure scenario
        run: |
          echo "Testing broker 3 failure..."
          docker stop kafka-3
          sleep 5

          echo "Verifying topics still accessible..."
          docker exec kafka-1 kafka-topics \
            --bootstrap-server kafka-1:29092 \
            --describe \
            --topic poc_orders

          echo "Restarting broker 3..."
          docker start kafka-3

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping cluster..."
          docker compose down -v
